import json
import requests
import csv
from datetime import date

today = date.today()
d1 = today.strftime("%d%m%y")
username = ''
PATtoken = '' # Change token if expired
URLworkitems = ''
URLattachments = '' # TO-FIX!


# Read range of IDs from prompt
idNumbers = 2000 # Change based on current max IDs
idWorkitems = [] # Empty array to place filtered IDs

for i in range(300, idNumbers):
    response = requests.get(f"{URLworkitems}{i}", auth=(username, PATtoken))
    print(f"..........Checking ID: {i}...........")
    if response.status_code == 404:
        continue
    elif response.status_code == 200:
        data = json.loads(response.text)
        areaPath = data['value'][0]['fields']['System.AreaPath']
        workItemType = data['value'][0]['fields']['System.WorkItemType']
        if areaPath == "Int_Perimeter" and workItemType == "Vulnerability Test":
            idWorkitems.append(i)
    else:
        print(f"Weird response for {i}...")
        print(response)

# Define CSV file headers
csv_headers = [
    'ID', 'Title', 'VAScanner', 'AssessmentDate', 'SecurityAssessment',
    'AssessmentType', 'Critical', 'High', 'Medium', 'Low'
]

# Open a CSV file for writing
with open(f'Vulnerability-Test-Results_{d1}.csv', mode='w', newline='') as csv_file:
    writer = csv.DictWriter(csv_file, fieldnames=csv_headers)
    writer.writeheader()

    for x in idWorkitems:
        response = requests.get(f"{URLworkitems}{x}", auth=(username, PATtoken))
        # Load JSON data
        data = json.loads(response.text)

        # Accessing data
        item_data = {
            'ID': data['value'][0]['id'],
            'Title': data['value'][0]['fields']['System.Title'],
            'VAScanner': data['value'][0]['fields']['Custom.VAScanner'],
            'AssessmentDate': data['value'][0]['fields']['Custom.AssessmentDate'],
            'SecurityAssessment': data['value'][0]['fields']['Custom.SecurityAssessment'],
            'AssessmentType': data['value'][0]['fields']['Custom.AssessmentType'],
            'Critical': data['value'][0]['fields']['Custom.Critical'],
            'High': data['value'][0]['fields']['Custom.High'],
            'Medium': data['value'][0]['fields']['Custom.Medium'],
            'Low': data['value'][0]['fields']['Custom.Low']
        }

        # Write row to CSV file
        writer.writerow(item_data)
